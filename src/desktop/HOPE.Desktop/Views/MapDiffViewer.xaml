<UserControl x:Class="HOPE.Desktop.Views.MapDiffViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:prism="http://prismlibrary.com/"
             prism:ViewModelLocator.AutoWireViewModel="True"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="#121212">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Text="3D MAP DIFF TOOL" Grid.Row="0" Foreground="White" FontSize="28" FontWeight="Bold" Margin="0,0,0,20"/>

        <!-- Controls -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,20">
            <ComboBox ItemsSource="{Binding AvailableCommits}" SelectedItem="{Binding SelectedBaseCommit}" 
                      DisplayMemberPath="DisplayText" Width="300" Margin="0,0,10,0"/>
            
            <TextBlock Text="VS" Foreground="White" VerticalAlignment="Center" Margin="10,0"/>
            
            <ComboBox ItemsSource="{Binding AvailableCommits}" SelectedItem="{Binding SelectedCompareCommit}" 
                      DisplayMemberPath="DisplayText" Width="300" Margin="10,0,0,0"/>
            
            <Button Content="Load History" Command="{Binding LoadHistoryCommand}" Margin="20,0,0,0" Padding="10,5"/>
            <Button Content="Show Diff" Command="{Binding GenerateDiffCommand}" Margin="10,0,0,0" Padding="10,5" Background="#2979FF" Foreground="White"/>
            <Button Content="Export PDF" Command="{Binding ExportReportCommand}" Margin="10,0,0,0" Padding="10,5" Background="#7B1FA2" Foreground="White"/>
            
            <TextBlock Text="{Binding StatusMessage}" Foreground="#AAAAAA" VerticalAlignment="Center" Margin="20,0,0,0"/>
        </StackPanel>

        <!-- 3D Viewports -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Base Map -->
            <Border Grid.Column="0" BorderBrush="#333" BorderThickness="1" Margin="0,0,5,0">
                <Grid>
                    <TextBlock Text="BASE MAP" Foreground="#888" Margin="10" VerticalAlignment="Top" HorizontalAlignment="Left" Panel.ZIndex="1"/>
                    <Viewport3D>
                        <Viewport3D.Camera>
                            <PerspectiveCamera Position="20, -20, 30" LookDirection="-1, 1, -1" UpDirection="0, 0, 1" FieldOfView="45"/>
                        </Viewport3D.Camera>
                        <ModelVisual3D>
                            <ModelVisual3D.Content>
                                <Model3DGroup>
                                    <DirectionalLight Color="White" Direction="-1,-1,-3" />
                                    <AmbientLight Color="#404040"/>
                                    <GeometryModel3D>
                                        <GeometryModel3D.Geometry>
                                            <MeshGeometry3D Positions="{Binding BaseSurfacePoints}"
                                                            TriangleIndices="{Binding BaseSurfaceIndices}"/>
                                        </GeometryModel3D.Geometry>
                                        <GeometryModel3D.Material>
                                            <DiffuseMaterial>
                                                <DiffuseMaterial.Brush>
                                                    <SolidColorBrush Color="#00BFFF" Opacity="0.8"/>
                                                </DiffuseMaterial.Brush>
                                            </DiffuseMaterial>
                                        </GeometryModel3D.Material>
                                        <GeometryModel3D.BackMaterial>
                                             <DiffuseMaterial Brush="Gray"/>
                                        </GeometryModel3D.BackMaterial>
                                    </GeometryModel3D>
                                </Model3DGroup>
                            </ModelVisual3D.Content>
                        </ModelVisual3D>
                    </Viewport3D>
                </Grid>
            </Border>

            <!-- Compare Map -->
            <Border Grid.Column="1" BorderBrush="#333" BorderThickness="1" Margin="5,0,0,0">
                <Grid>
                    <TextBlock Text="COMPARE MAP" Foreground="#888" Margin="10" VerticalAlignment="Top" HorizontalAlignment="Left" Panel.ZIndex="1"/>
                     <Viewport3D>
                        <Viewport3D.Camera>
                            <PerspectiveCamera Position="20, -20, 30" LookDirection="-1, 1, -1" UpDirection="0, 0, 1" FieldOfView="45"/>
                        </Viewport3D.Camera>
                        <ModelVisual3D>
                            <ModelVisual3D.Content>
                                <Model3DGroup>
                                    <DirectionalLight Color="White" Direction="-1,-1,-3" />
                                    <AmbientLight Color="#404040"/>
                                    <GeometryModel3D>
                                        <GeometryModel3D.Geometry>
                                            <MeshGeometry3D Positions="{Binding CompareSurfacePoints}"
                                                            TriangleIndices="{Binding CompareSurfaceIndices}"/>
                                        </GeometryModel3D.Geometry>
                                        <GeometryModel3D.Material>
                                            <DiffuseMaterial>
                                                <DiffuseMaterial.Brush>
                                                    <SolidColorBrush Color="#FF4081" Opacity="0.8"/>
                                                </DiffuseMaterial.Brush>
                                            </DiffuseMaterial>
                                        </GeometryModel3D.Material>
                                        <GeometryModel3D.BackMaterial>
                                             <DiffuseMaterial Brush="Gray"/>
                                        </GeometryModel3D.BackMaterial>
                                    </GeometryModel3D>
                                </Model3DGroup>
                            </ModelVisual3D.Content>
                        </ModelVisual3D>
                    </Viewport3D>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
